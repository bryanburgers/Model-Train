<!DOCTYPE html>
<html>
 <head>
  <title>Canvas Test</title>
 <script type="text/javascript" src="utility.js" ></script>
 <script type="text/javascript" src="endpoint.js" ></script>
 <script type="text/javascript" src="part.js" ></script>
 <script type="text/javascript" src="track.js" ></script>
 <script type="text/javascript" src="train.js" ></script>
 <script type="text/javascript" src="traverser.js" ></script>
 <script type="text/javascript" src="session.js" ></script>
 <script type="text/javascript">
  var fps = {
    last: new Date(),
    count: 0,
    upto: 10
  };
 
  var canvas;
  var ctx;
  var speed = 1;
  var traverser = null;
  var i = 128;
  var interval = null;
  var boxSettings = {
    rotate: 0,
    translateX: 20,
    translateY: 520,
    scale: 0.44444,
    toTransformString: function() {
      return "translate(" + this.translateX + "," + this.translateY + ") scale(" + this.scale + ") rotate(" + this.rotate + ")";
    },
    update: function() {
      document.getElementById("box").setAttribute("transform", this.toTransformString());
    }
  };  

  addEventListener("load", function(event) {
   document.addEventListener("click", function(event) { console.log(JSON.stringify(Session.trackPiecesToJson(pieces))); }, false);
   document.addEventListener("click", function(event) { clearInterval(interval); }, false);

   var s = {x:Part.straight248};
   var c45 = {x:Part.curve45_249};
   var rc45 = {x:Part.c45_249,e:"2"};

   pieces = Track.createTrack(Utility.createResult(0,0,0),
     [ s
     , c45
     , c45
     , c45
     , c45
     , s
     , s
     , c45
     , c45
     , c45
     , c45
     , s
     ]);
   canvas = document.getElementById("canvas");
   ctx = canvas.getContext("2d");

   var backgroundcanvas = document.getElementById("backgroundcanvas");
   var bctx = backgroundcanvas.getContext("2d");
   bctx.save();
   drawScenePreTransform(bctx);
   setupScene(bctx);   
   drawScenePostTransform(bctx);
   bctx.restore();

   //ctx.drawImage(backgroundcanvas, 0, 0);
   ctx.save();
   setupScene(ctx);

   var train = Train.createTrain("#train");   
   {
     var trackPiece = pieces[0];
     var endpoint = trackPiece.endpoints[0];
     traverser = trackPiece.traverserFromEndpoint(endpoint);
   }
   
   var initialResult = traverser.evaluate(i);
   Train.drawTrainCanvas(ctx, train, initialResult);   
   ctx.restore();
   interval = setInterval(moveTrain, 10);
  }, false);

  function moveTrain() {
   if (speed < 0.1) return;

   var backgroundcanvas = document.getElementById("backgroundcanvas");
   ctx.drawImage(backgroundcanvas, 0, 0, ctx.canvas.width, ctx.canvas.height);
   ctx.save();
   setupScene(ctx);

   var result = traverser.evaluate(i);
   Train.drawTrainCanvas(ctx, null, result);

   i += speed;
   var oldLength = traverser.length;
   if (i > traverser.length) {
     z = Train.findClosestTrackPiece(pieces, result, traverser.trackPiece);
     if (z) {
       traverser = z.trackPiece.traverserFromEndpoint(z.endpoint);
     }
   }
   while (i > oldLength) { i -= oldLength; }
   ctx.restore();

   updateFps();
  }

  function updateFps() {
    var now = new Date();
    fps.count++;
    if (fps.count > fps.upto) {
      var fpsD = document.getElementById("fps");
      fpsD.textContent = ((fps.count * 1000) / (now - fps.last)).toString();

      if (now - fps.last < 500) {
        fps.upto = fps.upto * 1.2;
      }

      if (now - fps.last > 2000) {
        fps.upto = fps.upto * 0.8;
      }      

      fps.count = 0;
      fps.last = now;
    }
  }

  function setupScene(ctx) {
   ctx.scale(boxSettings.scale, boxSettings.scale);

   ctx.translate(boxSettings.translateX, boxSettings.translateY);
// rotate
  }

  function drawScenePreTransform(ctx) {
   ctx.fillStyle = "#080";
   ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height);
  }

  function drawScenePostTransform(ctx) {
   for (var i = 0; i < pieces.length; i++) {
    Track.drawTrackPieceCanvas(ctx, pieces[i]);
   }
  }

  </script>
  <style type="text/css">
    * { padding: 0px; margin: 0px; }
  </style>
 </head>
 <body>
   <canvas id="backgroundcanvas" width="250" height="480" style="display: none;"></canvas>
   <canvas id="canvas" width="250" height="480"></canvas>
   <p id="fps">&nbsp;</p>
 </body>
</html>